<!DOCTYPE html>
<html lang="en">
<link rel="stylesheet" type="text/css" href="/style.css">

<head>
  <title>Tic Tac Toe</title>
  <script>
    const handleResponse = async (response, gridData, parseBool) => { 
      switch (response.status) {
        case 200:
          console.log('success!');
          break;
        case 204:
          console.log('no data!');
          break;
        default:
          console.log(`Error code not implemented by client.`);
          break;
      }

      if (parseBool) {
        let data = await response.json();
        const nodeData = data.body;
        console.log(nodeData);
        for (let i = 0; i < 9; i++) {
          gridData[i].innerText = nodeData[i];
        }
      }
    }

    const squareClick = async (square, gridData) => {
      if (square.innerHTML) return;
      square.innerHTML = 'X';
      let dataArray = [];
      for (const element of gridData) dataArray.push(element.innerHTML);
      const dataString = 'board=' + dataArray.join();

      let response = await fetch('/sendData', {
        method: 'post',
        headers: {
          'Content-Type': 'application/x-www-form-urlencoded',
          'Accept': 'application/json',
        },
        body: dataString,
      });

      handleResponse(response, gridData, false);
    }

    const getBoard = async (gridData, url) => {
      const response = await fetch(url);
      if (response.status == 502) {
        console.log('error');
        await getBoard(gridData, '/getData?longpoll=true');
      } else {
        console.log('resending');
        handleResponse(response, gridData, true);
        await getBoard(gridData, '/getData?longpoll=true');
      }
    };

    const init = () => {
      const gridData = document.querySelectorAll('.grid-item');

      const sendBoardData = (e) => {
        squareClick(e.target, gridData);
      }

      getBoard(gridData, '/getData');

      gridData.forEach(square => square.onclick = sendBoardData);
    }

    window.addEventListener('load', init);
  </script>
</head>

<body>
  <section id="top">
    <h1 id="title"><b>Tic Tac Toe Server</b></h1>
  </section>
  <div id="game-grid">
    <div class="grid-item" id="0"></div>
    <div class="grid-item vertical" id="1"></div>
    <div class="grid-item" id="2"></div>
    <div class="grid-item horizontal" id="3"></div>
    <div class="grid-item vertical horizontal" id="4"></div>
    <div class="grid-item horizontal" id="5"></div>
    <div class="grid-item" id="6"></div>
    <div class="grid-item vertical" id="7"></div>
    <div class="grid-item" id="8"></div>
  </div>
</body>

</html>